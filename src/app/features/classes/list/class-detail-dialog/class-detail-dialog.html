<p-toast position="top-right"></p-toast>

<p-dialog
  [(visible)]="visible"
  [modal]="true"
  [draggable]="false"
  [style]="{ width: editMode() ? '1200px' : '1100px', maxWidth: '95vw' }"
  [contentStyle]="{ minHeight: editMode() ? '520px' : '450px' }"
  [header]="dialogHeader"
  (onHide)="hide()"
  (onShow)="onShow()"
>
  @if (classItem || mode === 'create') {

    <!-- ============ VIEW MODE ============ -->
    @if (!editMode()) {

      <!-- Header -->
      <div class="view-header">
        <div class="flex-1">
          <div class="view-title">{{ classItem?.title }}</div>
          <div class="view-description">{{ classItem?.description || 'Χωρίς περιγραφή' }}</div>
        </div>
        @if (classItem) {
          <div class="view-status">
            <p-tag
              [value]="typeLabel(classItem.type)"
              [severity]="classItem.type === 'workshop' ? 'warn' : 'info'"
              [style]="{ fontSize: '0.95rem', padding: '0.35rem 0.85rem' }"
            ></p-tag>
            <p-tag
              [value]="classItem.active ? 'Ενεργό' : 'Ανενεργό'"
              [severity]="classItem.active ? 'success' : 'secondary'"
              [style]="{ fontSize: '0.95rem', padding: '0.35rem 0.85rem' }"
            ></p-tag>
          </div>
        }
      </div>

      <!-- Info cards row -->
      @if (classItem) {
        <div class="info-cards">

          @if (classItem.type !== 'workshop') {
            <!-- Weekly: Day -->
            <div class="info-card">
              <div class="info-card-icon">
                <i class="pi pi-calendar"></i>
              </div>
              <div class="info-card-content">
                <div class="info-card-label">Ημέρα</div>
                <div class="info-card-value">{{ dayLabel(classItem.day_of_week) }}</div>
              </div>
            </div>

            <!-- Weekly: Time -->
            <div class="info-card">
              <div class="info-card-icon">
                <i class="pi pi-clock"></i>
              </div>
              <div class="info-card-content">
                <div class="info-card-label">Ωράριο</div>
                <div class="info-card-value">
                  @if (classItem.starts_time && classItem.ends_time) {
                    {{ classItem.starts_time.slice(0,5) }} – {{ classItem.ends_time.slice(0,5) }}
                  } @else {
                    —
                  }
                </div>
              </div>
            </div>
          }

          <!-- Teacher -->
          <div class="info-card">
            <div class="info-card-icon">
              <i class="pi pi-user"></i>
            </div>
            <div class="info-card-content">
              <div class="info-card-label">Καθηγητής</div>
              <div class="info-card-value">{{ classItem.teacher?.name || '—' }}</div>
            </div>
          </div>

          <!-- Capacity -->
          <div class="info-card">
            <div class="info-card-icon">
              <i class="pi pi-users"></i>
            </div>
            <div class="info-card-content">
              <div class="info-card-label">Χωρητικότητα</div>
              <div class="info-card-value">
                @if (classItem.capacity != null) {
                  {{ classItem.capacity }} άτομα
                } @else {
                  —
                }
              </div>
            </div>
          </div>

          <!-- Monthly Price -->
          <div class="info-card">
            <div class="info-card-icon">
              <i class="pi pi-euro"></i>
            </div>
            <div class="info-card-content">
              <div class="info-card-label">Μηνιαία τιμή</div>
              <div class="info-card-value">
                @if (classItem.monthly_price != null) {
                  {{ classItem.monthly_price | currency:'EUR':'symbol':'1.2-2' }}
                } @else {
                  —
                }
              </div>
            </div>
          </div>
        </div>

        <!-- Workshop sessions list -->
        @if (classItem.type === 'workshop') {
          <div class="sessions-section">
            <div class="sessions-title">
              <i class="pi pi-calendar mr-2"></i>Ημερομηνίες Workshop
            </div>
            @if (classItem.sessions && classItem.sessions.length > 0) {
              <div class="sessions-grid">
                @for (s of classItem.sessions; track s.id ?? $index; let i = $index) {
                  <div class="session-card">
                    <div class="session-index">{{ i + 1 }}</div>
                    <div class="session-date">{{ s.date }}</div>
                    <div class="session-time">
                      <i class="pi pi-clock mr-1"></i>
                      {{ s.starts_time?.slice(0,5) }} – {{ s.ends_time?.slice(0,5) }}
                    </div>
                  </div>
                }
              </div>
            } @else {
              <div class="text-lg text-500 p-3 text-center">Δεν υπάρχουν ημερομηνίες</div>
            }
          </div>
        }

        <!-- Enrolled Students Section (only for weekly classes) -->
        @if (classItem.type === 'weekly') {
          <div class="enrolled-students-section mt-4">
            <div class="flex align-items-center justify-content-between mb-3">
              <div class="flex align-items-center gap-2">
                <span class="font-semibold text-lg">Εγγεγραμμένοι Μαθητές</span>
                <p-tag
                  [value]="capacityDisplay()"
                  [severity]="capacitySeverity()"
                  [style]="{ fontSize: '0.85rem' }">
                </p-tag>
              </div>
            </div>

            @if (loadingEnrollments()) {
              <div class="text-center p-3">
                <i class="pi pi-spin pi-spinner"></i> Φόρτωση...
              </div>
            } @else if (enrolledStudents().length === 0) {
              <div class="text-center text-600 p-3 surface-50 border-round">
                Δεν υπάρχουν εγγεγραμμένοι μαθητές
              </div>
            } @else {
              <p-table [value]="enrolledStudents()" [tableStyle]="{ 'min-width': '100%' }" styleClass="p-datatable-sm">
                <ng-template pTemplate="header">
                  <tr>
                    <th>Μαθητής</th>
                    <th>Email</th>
                    <th>Τηλέφωνο</th>
                    <th>Ημ/νία εγγραφής</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-enrollment>
                  <tr>
                    <td>
                      <span class="font-medium">{{ enrollment.student?.name || '—' }}</span>
                    </td>
                    <td>
                      @if (enrollment.student?.email) {
                        <a [href]="'mailto:' + enrollment.student.email" class="text-primary">
                          {{ enrollment.student.email }}
                        </a>
                      } @else {
                        —
                      }
                    </td>
                    <td>
                      @if (enrollment.student?.phone) {
                        <a [href]="'tel:' + enrollment.student.phone" class="text-primary">
                          {{ enrollment.student.phone }}
                        </a>
                      } @else {
                        —
                      }
                    </td>
                    <td>{{ enrollment.enrolled_at | date:'dd/MM/yyyy' }}</td>
                  </tr>
                </ng-template>
              </p-table>
            }
          </div>
        }
      }

    <!-- ============ EDIT / CREATE MODE ============ -->
    } @else {

      <div class="grid">
        <div class="col-12 md:col-6">
          <label class="block font-semibold mb-1">Τίτλος</label>
          <input pInputText class="w-full" placeholder="Τίτλος τμήματος" [formControl]="ctrl('title')" />
        </div>
        <div class="col-12 md:col-6">
          <label class="block font-semibold mb-1">Περιγραφή</label>
          <input pInputText class="w-full" placeholder="Περιγραφή (προαιρετικά)" [formControl]="ctrl('description')" />
        </div>
      </div>

      <p-divider></p-divider>

      <div class="mb-3">
        <label class="block font-semibold mb-1">Τύπος</label>
        <p-select
          [options]="typeOptions"
          [formControl]="ctrl('type')"
          optionLabel="label"
          optionValue="value"
          [style]="{ width: '220px' }"
          appendTo="body"
        ></p-select>
      </div>

      <div class="grid">

        <!-- Weekly schedule (edit) -->
        @if (typeValue === 'weekly') {
          <div class="col-12 md:col-6">
            <div class="font-semibold text-lg mb-3">Πρόγραμμα</div>
            <div class="mb-3">
              <label class="block font-semibold mb-1">Ημέρα</label>
              <p-select class="w-full" [options]="dayOptions" [formControl]="ctrl('day_of_week')" optionLabel="label" optionValue="value" placeholder="Επιλέξτε ημέρα" appendTo="body"></p-select>
            </div>
            <div class="grid">
              <div class="col-6">
                <label class="block font-semibold mb-1">Ώρα έναρξης</label>
                <p-datepicker
                  [formControl]="ctrl('starts_time')"
                  [timeOnly]="true"
                  [hourFormat]="'24'"
                  [showIcon]="true"
                  [iconDisplay]="'input'"
                  icon="pi pi-clock"
                  placeholder="Επιλέξτε ώρα"
                  styleClass="w-full"
                  appendTo="body"
                ></p-datepicker>
              </div>
              <div class="col-6">
                <label class="block font-semibold mb-1">Ώρα λήξης</label>
                <p-datepicker
                  [formControl]="ctrl('ends_time')"
                  [timeOnly]="true"
                  [hourFormat]="'24'"
                  [showIcon]="true"
                  [iconDisplay]="'input'"
                  icon="pi pi-clock"
                  placeholder="Επιλέξτε ώρα"
                  styleClass="w-full"
                  appendTo="body"
                ></p-datepicker>
              </div>
            </div>
          </div>
        }

        <!-- Workshop sessions (edit) -->
        @if (typeValue === 'workshop') {
          <div class="col-12 md:col-6">
            <div class="font-semibold text-lg mb-3">Ημερομηνίες Workshop</div>
            @for (sessionCtrl of sessionsArray.controls; track $index; let i = $index) {
              <div class="grid mb-2 align-items-end" [formGroup]="$any(sessionCtrl)">
                <div class="col-4">
                  @if (i === 0) { <label class="block font-semibold mb-1">Ημερομηνία</label> }
                  <input pInputText type="date" formControlName="date" class="w-full" />
                </div>
                <div class="col-3">
                  @if (i === 0) { <label class="block font-semibold mb-1">Έναρξη</label> }
                  <p-datepicker
                    formControlName="starts_time"
                    [timeOnly]="true"
                    [hourFormat]="'24'"
                    placeholder="Ώρα"
                    styleClass="w-full"
                    appendTo="body"
                  ></p-datepicker>
                </div>
                <div class="col-3">
                  @if (i === 0) { <label class="block font-semibold mb-1">Λήξη</label> }
                  <p-datepicker
                    formControlName="ends_time"
                    [timeOnly]="true"
                    [hourFormat]="'24'"
                    placeholder="Ώρα"
                    styleClass="w-full"
                    appendTo="body"
                  ></p-datepicker>
                </div>
                <div class="col-2">
                  @if (i === 0) { <label class="block mb-1">&nbsp;</label> }
                  <button pButton icon="pi pi-trash" severity="danger" rounded outlined size="small" (click)="removeSession($index)"></button>
                </div>
              </div>
            }
            <button pButton icon="pi pi-plus" label="Προσθήκη ημέρας" class="p-button-text p-button-sm mt-1" (click)="addSession()"></button>
          </div>
        }

        <!-- Details (edit) -->
        <div class="col-12 md:col-6">
          <div class="font-semibold text-lg mb-3">Στοιχεία</div>
          <div class="mb-3">
            <label class="block font-semibold mb-1">Καθηγητής</label>
            <p-select
              class="w-full"
              [options]="teachers()"
              [formControl]="ctrl('teacher_id')"
              optionLabel="name"
              optionValue="id"
              placeholder="Επιλέξτε καθηγητή"
              [showClear]="true"
              [filter]="true"
              filterPlaceholder="Αναζήτηση..."
              appendTo="body"
            ></p-select>
          </div>
          <div class="mb-3">
            <label class="block font-semibold mb-1">Χωρητικότητα</label>
            <input pInputText type="number" class="w-full" placeholder="π.χ. 20" [formControl]="ctrl('capacity')" />
          </div>
          <div class="mb-3">
            <label class="block font-semibold mb-1">Μηνιαία τιμή (€)</label>
            <input pInputText type="number" step="0.01" class="w-full" placeholder="π.χ. 40.00" [formControl]="ctrl('monthly_price')" />
          </div>
          @if (mode !== 'create') {
            <div class="mb-3">
              <label class="block font-semibold mb-1">Κατάσταση</label>
              <div class="toggle-row">
                <p-toggleswitch [formControl]="ctrl('active')"></p-toggleswitch>
                <span class="toggle-label" [class.active]="ctrl('active').value" [class.inactive]="!ctrl('active').value">
                  {{ ctrl('active').value ? 'Ενεργό' : 'Ανενεργό' }}
                </span>
              </div>
            </div>
          }
        </div>

      </div>
    }
  }

  <ng-template pTemplate="footer">
    @if (!editMode()) {
      <button pButton label="Επεξεργασία" icon="pi pi-pencil" (click)="enterEdit()"></button>
      <button pButton label="Κλείσιμο" icon="pi pi-times" class="p-button-text" (click)="hide()"></button>
    } @else {
      <button pButton label="Ακύρωση" icon="pi pi-times" class="p-button-text" (click)="cancelEdit()"></button>
      <button
        pButton
        [label]="mode === 'create' ? 'Δημιουργία' : 'Αποθήκευση'"
        [icon]="mode === 'create' ? 'pi pi-plus' : 'pi pi-check'"
        class="p-button-success"
        [loading]="saving()"
        [disabled]="saving()"
        (click)="save()"
      ></button>
    }
  </ng-template>
</p-dialog>
