<p-dialog
  [(visible)]="visible"
  [modal]="true"
  [draggable]="false"
  [style]="{ width: '860px', maxWidth: '95vw' }"
  header="Λεπτομέρειες Μαθητή"
  (onHide)="hide()"
>
  @if (student) {

    <!-- Header -->
    <div class="mb-2 flex align-items-center justify-content-between">

      <!-- LEFT: Name -->
      <div>
        <h3 class="m-0 flex align-items-center gap-2">
          @if (!editMode()) {
            {{ student.name }}
          } @else {
            <div class="flex gap-2">
              <input
                pInputText
                class="w-10rem"
                placeholder="Όνομα"
                [formControl]="ctrl('first_name')"
              >
              <input
                pInputText
                class="w-12rem"
                placeholder="Επώνυμο"
                [formControl]="ctrl('last_name')"
              >
            </div>
          }
        </h3>
      </div>

      <!-- RIGHT: Birthday & Age -->
      <div class="flex align-items-center gap-2 text-sm text-600">
        @if (!editMode()) {
          <p-tag
            *ngIf="age(student.birthdate) !== null"
            [value]="age(student.birthdate) + ' ετών'"
            severity="secondary"
            styleClass="text-xs"
          ></p-tag>
          <span>
            Ημ/νία γέννησης:
            {{ student.birthdate ? (student.birthdate | date:'dd/MM/yyyy') : '—' }}
          </span>
        } @else {
          <p-datePicker
            dateFormat="dd/mm/yy"
            [showIcon]="true"
            appendTo="body"
            [formControl]="ctrl('birthdate')"
          ></p-datePicker>
        }
      </div>
    </div>

    <p-divider></p-divider>

    <!-- MEMBERSHIP (READ-ONLY) -->
    <div class="membership-box">
      <div class="font-semibold mb-2">Κατάσταση μέλους</div>

      <div class="flex align-items-center justify-content-between gap-3">
        <!-- LEFT: status -->
        <div class="flex align-items-center gap-3">
          <p-tag
            [value]="student.is_member ? 'Ενεργό μέλος' : 'Μη μέλος'"
            [severity]="student.is_member ? 'success' : 'secondary'">
          </p-tag>

          <span class="text-sm text-600">
            {{ student.is_member
              ? 'Η ετήσια εγγραφή είναι ενεργή.'
              : 'Δεν υπάρχει ενεργή ετήσια εγγραφή.' }}
          </span>
        </div>

        <!-- RIGHT: action -->
        @if (!student.is_member) {
          <button
            pButton
            icon="pi pi-plus"
            label="Καταχώρηση ετήσιας συμμετοχής"
            class="p-button-sm"
            (click)="openRegistrationDialog()">
          </button>
        } @else {
          <button
            pButton
            icon="pi pi-eye"
            label="Προβολή ιστορικού"
            class="p-button-sm p-button-text"
            (click)="openHistoryDialog()">
          </button>
        }
      </div>
    </div>


    <p-divider></p-divider>

    <div class="grid">

      <!-- Contact -->
      <div class="col-12 md:col-6">
        <div class="font-semibold mb-2">Επικοινωνία</div>

        <div class="line">
          <span class="label">Email:</span>
          @if (!editMode()) {
            <ng-container *ngIf="student.email; else noEmail">
              <a [href]="'mailto:' + student.email">{{ student.email }}</a>
            </ng-container>
            <ng-template #noEmail>—</ng-template>
          } @else {
            <input pInputText [formControl]="ctrl('email')" placeholder="name@example.com">
          }
        </div>

        <div class="line">
          <span class="label">Τηλέφωνο:</span>
          @if (!editMode()) {
            <ng-container *ngIf="student.phone; else noPhone">
              <a [href]="'tel:' + student.phone">{{ student.phone }}</a>
            </ng-container>
            <ng-template #noPhone>—</ng-template>
          } @else {
            <input pInputText [formControl]="ctrl('phone')" placeholder="69xxxxxxxx">
          }
        </div>

        <div class="line">
          <span class="label">Διεύθυνση:</span>
          @if (!editMode()) {
            <ng-container
              *ngIf="student.address?.street || student.address?.city || student.address?.zip; else noAddr">
              <span class="ml-1">
                {{ student.address?.street || '' }}
                {{ student.address?.city ? ', ' + student.address?.city : '' }}
                {{ student.address?.zip ? ' ' + student.address?.zip : '' }}
              </span>
            </ng-container>
            <ng-template #noAddr>—</ng-template>
          } @else {
            <div class="flex flex-column gap-2 w-full">
              <input pInputText placeholder="Οδός" [formControl]="ctrl('address.street')">
              <div class="flex gap-2">
                <input pInputText class="w-full" placeholder="Πόλη" [formControl]="ctrl('address.city')">
                <input pInputText style="width:8rem" placeholder="ΤΚ" [formControl]="ctrl('address.zip')">
              </div>
            </div>
          }
        </div>
      </div>

      <!-- Studies -->
      <div class="col-12 md:col-6">
        <div class="font-semibold mb-2">Σπουδές</div>

        <div class="line align-items-center">
          <span class="label">Επίπεδο:</span>
          @if (!editMode()) {
            <p-tag
              class="ml-2"
              [value]="levelLabel(student.level)"
              [severity]="levelSeverity(student.level)"
            ></p-tag>
          } @else {
            <p-select
              class="ml-2 w-full"
              [options]="[
                {label:'Αρχάριος', value:'beginner'},
                {label:'Μέσος', value:'intermediate'},
                {label:'Προχωρημένος', value:'advanced'}
              ]"
              [formControl]="ctrl('level')"
            ></p-select>
          }
        </div>

        <div class="line align-items-start">
          <span class="label">Ενδιαφέροντα:</span>
          @if (!editMode()) {
            <ng-container *ngIf="student.interests?.length; else noInterests">
              <span class="ml-2 flex flex-wrap gap-2">
                <p-tag
                  *ngFor="let i of interestLabels(student.interests)"
                  [value]="i"
                  severity="secondary"
                ></p-tag>
              </span>
            </ng-container>
            <ng-template #noInterests>—</ng-template>
          } @else {
            <p-multiSelect
              class="ml-2 w-full"
              [options]="[
                {label:'Ζωγραφική', value:'painting'},
                {label:'Κεραμική', value:'ceramics'},
                {label:'Σχέδιο', value:'drawing'}
              ]"
              [formControl]="ctrl('interests')"
            ></p-multiSelect>
          }
        </div>

        <div class="line align-items-center">
          <span class="label">Media consent:</span>
          @if (!editMode()) {
            <p-tag
              class="ml-2"
              [value]="student.consent_media ? 'Ναι' : 'Όχι'"
              [severity]="student.consent_media ? 'success' : 'secondary'"
            ></p-tag>
          } @else {
            <p-checkbox
              binary="true"
              [formControl]="ctrl('consent_media')"
              inputId="consent_media"
            ></p-checkbox>
          }
        </div>
      </div>
    </div>

    <p-divider></p-divider>

    <!-- Notes -->
    <div class="grid">
      <div class="col-12 md:col-6">
        <div class="font-semibold mb-2">Σημειώσεις</div>
        @if (!editMode()) {
          <div class="whitespace-pre-wrap">{{ student.notes || '—' }}</div>
        } @else {
          <textarea
            class="p-inputtext p-component w-full border border-surface-300 rounded-md p-2"
            rows="4"
            [formControl]="ctrl('notes')"
          ></textarea>
        }
      </div>

      <div class="col-12 md:col-6">
        <div class="font-semibold mb-2">Ιατρικές σημειώσεις</div>
        @if (!editMode()) {
          <div class="whitespace-pre-wrap">{{ student.medical_note || '—' }}</div>
        } @else {
          <textarea
            class="p-inputtext p-component w-full border border-surface-300 rounded-md p-2"
            rows="4"
            [formControl]="ctrl('medical_note')"
          ></textarea>
        }
      </div>
    </div>

    <p-divider></p-divider>

    <!-- Guardians -->
    <div class="font-semibold mb-2">Κηδεμόνας/ες</div>
    <ng-container *ngIf="student.guardians?.length; else noGuardians">
      <div class="flex flex-column gap-2">
        <div *ngFor="let g of student.guardians" class="surface-50 border-round p-2">
          <div class="font-medium">{{ g.name }}</div>
          <div class="text-sm flex flex-column gap-1">
            <div *ngIf="g.email" class="flex align-items-center gap-2">
              <i class="pi pi-envelope"></i>
              <a [href]="'mailto:' + g.email">{{ g.email }}</a>
            </div>
            <div *ngIf="g.phone" class="flex align-items-center gap-2">
              <i class="pi pi-phone"></i>
              <a [href]="'tel:' + g.phone">{{ g.phone }}</a>
            </div>
            <div *ngIf="g.address?.street || g.address?.city || g.address?.zip"
                 class="flex align-items-start gap-2">
              <i class="pi pi-map-marker mt-1"></i>
              <span>
                {{ g.address?.street || '' }}
                {{ g.address?.city ? ', ' + g.address?.city : '' }}
                {{ g.address?.zip ? ' ' + g.address?.zip : '' }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </ng-container>
    <ng-template #noGuardians>—</ng-template>

    <p-divider></p-divider>

    <!-- Enrolled Classes Section -->
    <div class="enrollments-section">
      <div class="flex align-items-center justify-content-between mb-3">
        <div class="font-semibold text-lg">Εγγεγραμμένα Μαθήματα</div>
        @if (student.is_member && !editMode()) {
          <button
            pButton
            icon="pi pi-plus"
            label="Εγγραφή σε μάθημα"
            class="p-button-sm"
            (click)="openEnrollDialog()">
          </button>
        }
      </div>

      @if (loadingEnrollments()) {
        <div class="text-center p-3">
          <i class="pi pi-spin pi-spinner"></i> Φόρτωση...
        </div>
      } @else if (enrollments().length === 0) {
        <div class="text-center text-600 p-3 surface-50 border-round">
          Δεν υπάρχουν εγγραφές σε μαθήματα
        </div>
      } @else {
        <p-table [value]="enrollments()" [tableStyle]="{ 'min-width': '100%' }" styleClass="p-datatable-sm">
          <ng-template pTemplate="header">
            <tr>
              <th>Μάθημα</th>
              <th>Ημέρα</th>
              <th>Ώρα</th>
              <th>Έκπτωση</th>
              <th>Κατάσταση</th>
              <th>Ημ/νία εγγραφής</th>
              <th style="width: 110px"></th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-enrollment>
            <tr>
              <td>{{ enrollment.course_class?.title || '—' }}</td>
              <td>{{ dayLabel(enrollment.course_class?.day_of_week) }}</td>
              <td>
                @if (enrollment.course_class?.starts_time && enrollment.course_class?.ends_time) {
                  {{ enrollment.course_class.starts_time.slice(0,5) }}–{{ enrollment.course_class.ends_time.slice(0,5) }}
                } @else {
                  —
                }
              </td>
              <td>
                @if (enrollment.discount_percent > 0 || enrollment.discount_amount > 0) {
                  <span class="text-sm">
                    @if (enrollment.discount_percent > 0) {
                      {{ enrollment.discount_percent }}%
                    }
                    @if (enrollment.discount_percent > 0 && enrollment.discount_amount > 0) {
                      +
                    }
                    @if (enrollment.discount_amount > 0) {
                      {{ enrollment.discount_amount | currency:'EUR':'symbol':'1.2-2' }}
                    }
                  </span>
                } @else {
                  <span class="text-400">—</span>
                }
              </td>
              <td>
                <p-tag
                  [value]="enrollment.status === 'active' ? 'Ενεργή' : 'Αποχώρηση'"
                  [severity]="enrollment.status === 'active' ? 'success' : 'secondary'">
                </p-tag>
              </td>
              <td>{{ enrollment.enrolled_at | date:'dd/MM/yyyy' }}</td>
              <td>
                @if (enrollment.status === 'active') {
                  <button
                    pButton
                    icon="pi pi-percentage"
                    class="p-button-text p-button-sm"
                    pTooltip="Επεξεργασία έκπτωσης"
                    (click)="editEnrollmentDiscount(enrollment)">
                  </button>
                  <button
                    pButton
                    icon="pi pi-sign-out"
                    class="p-button-text p-button-sm p-button-danger"
                    pTooltip="Αποχώρηση"
                    (click)="withdrawEnrollment(enrollment)">
                  </button>
                }
              </td>
            </tr>
          </ng-template>
        </p-table>
      }
    </div>

    <p-divider></p-divider>

    <!-- Payment Summary Section -->
    <div class="payment-section">
      <div class="flex align-items-center justify-content-between mb-3">
        <div class="font-semibold text-lg">Οικονομικά</div>
        <button
          pButton
          label="Λεπτομέρειες"
          icon="pi pi-list"
          class="p-button-sm p-button-text"
          (click)="openPaymentDialog()">
        </button>
      </div>

      @if (loadingPayments()) {
        <div class="text-center p-3">
          <i class="pi pi-spin pi-spinner"></i> Φόρτωση...
        </div>
      } @else if (paymentSummary()) {
        <!-- Summary Cards -->
        <div class="grid">
          <div class="col-6">
            <div class="surface-50 border-round p-3">
              <div class="text-600 text-sm">Σύνολο πληρωμένων</div>
              <div class="text-xl font-bold text-green-600">
                {{ paymentSummary()!.total_paid | currency:'EUR':'symbol':'1.2-2' }}
              </div>
            </div>
          </div>
          <div class="col-6">
            <div class="surface-50 border-round p-3">
              <div class="text-600 text-sm">Εκκρεμείς οφειλές</div>
              <div class="text-xl font-bold"
                   [class.text-red-600]="paymentSummary()!.total_outstanding > 0">
                {{ paymentSummary()!.total_outstanding | currency:'EUR':'symbol':'1.2-2' }}
              </div>
            </div>
          </div>
        </div>

        <!-- Outstanding Dues List (if any) -->
        @if (paymentSummary()!.outstanding_dues?.length) {
          <div class="mt-3">
            <div class="text-sm text-600 mb-2">Εκκρεμείς οφειλές:</div>
            <p-table [value]="paymentSummary()!.outstanding_dues" styleClass="p-datatable-sm">
              <ng-template pTemplate="body" let-due>
                <tr>
                  <td>{{ due.period }}</td>
                  <td>{{ due.class?.title }}</td>
                  <td class="text-right">{{ due.amount | currency:'EUR':'symbol':'1.2-2' }}</td>
                  <td class="text-right" style="width: 60px">
                    <button
                      pButton
                      icon="pi pi-check"
                      class="p-button-sm p-button-success p-button-text"
                      pTooltip="Πληρώθηκε"
                      (click)="payDue(due)">
                    </button>
                  </td>
                </tr>
              </ng-template>
            </p-table>
          </div>
        }
      } @else {
        <div class="text-center text-600 p-3 surface-50 border-round">
          Δεν υπάρχουν οικονομικά στοιχεία
        </div>
      }
    </div>
  }

  <!-- Footer -->
  <ng-template pTemplate="footer">
    @if (!editMode()) {
      <button pButton label="Επεξεργασία" (click)="enterEdit()"></button>
      <button pButton label="Κλείσιμο" class="p-button-text" (click)="hide()"></button>
    } @else {
      <button pButton label="Ακύρωση" class="p-button-text" (click)="cancelEdit()"></button>
      <button
        pButton
        label="Αποθήκευση"
        class="p-button-success"
        [loading]="saving()"
        [disabled]="saving()"
        (click)="save()"
      ></button>
    }
  </ng-template>
</p-dialog>



<p-dialog
  [visible]="registrationDialogVisible()"
  (visibleChange)="registrationDialogVisible.set($event)"
  [modal]="true"
  [draggable]="false"
  [style]="{ width: '420px', maxWidth: '95vw' }"
  header="Ετήσια εγγραφή"
  [closable]="true"
  [dismissableMask]="true"
>
  @if (registrationPreview()) {

    <div class="mb-3">
      <div class="text-sm text-600 mb-1">Μαθητής</div>
      <div class="font-semibold">{{ student?.name }}</div>
    </div>

    <p-divider></p-divider>

    <div class="mb-3">
      <div class="text-sm text-600 mb-1">Έναρξη εγγραφής</div>
      <p-datePicker
        [(ngModel)]="registrationStartDate"
        (ngModelChange)="onRegistrationStartChange($event)"
        [showIcon]="true"
        dateFormat="dd/mm/yy"
        appendTo="body"
      ></p-datePicker>
    </div>

    <div class="mb-3">
      <div class="text-sm text-600 mb-1">Λήξη εγγραφής</div>
      <div class="font-medium">
        {{ registrationPreview()!.ends_at | date:'dd/MM/yyyy' }}
      </div>
    </div>

    <p-divider></p-divider>

    <div class="text-sm text-600 mb-3 flex align-items-start gap-2">
      <i class="pi pi-info-circle mt-1"></i>
      <span>
        Η ετήσια εγγραφή ισχύει για ένα (1) έτος από την ημερομηνία έναρξης.
      </span>
    </div>
  } @else {
    <div class="text-sm text-600">Φόρτωση...</div>
  }

  <ng-template pTemplate="footer">
    <button
      pButton
      label="Ακύρωση"
      class="p-button-text"
      (click)="registrationDialogVisible.set(false)"
    ></button>

    <button
      pButton
      label="Καταχώρηση"
      class="p-button-sm"
      [disabled]="saving()"
      (click)="confirmRegistration()"
    ></button>
  </ng-template>
</p-dialog>

@if (student) {
  <app-student-history-dialog
    [visible]="historyDialogVisible()"
    (visibleChange)="historyDialogVisible.set($event)"
    [studentId]="student.id">
  </app-student-history-dialog>

  <app-student-payment-dialog
    [visible]="paymentDialogVisible()"
    (visibleChange)="paymentDialogVisible.set($event)"
    [studentId]="student.id"
    (paymentChanged)="onPaymentDialogClose()">
  </app-student-payment-dialog>
}

<!-- Enroll in class dialog -->
<p-dialog
  [visible]="enrollDialogVisible()"
  (visibleChange)="enrollDialogVisible.set($event)"
  [modal]="true"
  [draggable]="false"
  [style]="{ width: '480px', maxWidth: '95vw' }"
  header="Εγγραφή σε μάθημα"
  [closable]="true"
  [dismissableMask]="true"
>
  <div class="mb-3">
    <div class="text-sm text-600 mb-1">Μαθητής</div>
    <div class="font-semibold">{{ student?.name }}</div>
  </div>

  <p-divider></p-divider>

  @if (loadingClasses()) {
    <div class="text-center p-4">
      <i class="pi pi-spin pi-spinner mr-2"></i> Φόρτωση μαθημάτων...
    </div>
  } @else if (availableClasses().length === 0) {
    <div class="text-center text-600 p-4">
      Δεν υπάρχουν διαθέσιμα μαθήματα για εγγραφή
    </div>
  } @else {
    <div class="mb-3">
      <label class="block font-semibold mb-2">Επιλέξτε μάθημα</label>
      <p-select
        [options]="availableClasses()"
        [(ngModel)]="selectedClassId"
        optionLabel="title"
        optionValue="id"
        placeholder="Επιλέξτε..."
        [style]="{ width: '100%' }"
        appendTo="body"
      >
        <ng-template pTemplate="item" let-item>
          <div class="flex flex-column">
            <span class="font-medium">{{ item.title }}</span>
            <span class="text-sm text-600">
              {{ dayLabel(item.day_of_week) }}
              @if (item.starts_time && item.ends_time) {
                • {{ item.starts_time.slice(0,5) }}–{{ item.ends_time.slice(0,5) }}
              }
              @if (item.capacity) {
                • Χωρητικότητα: {{ item.capacity }}
              }
            </span>
          </div>
        </ng-template>
      </p-select>
    </div>

    <p-divider></p-divider>

    <div class="text-sm text-600 mb-2">Έκπτωση (προαιρετικά)</div>
    <div class="grid">
      <div class="col-6">
        <label class="block text-sm mb-1">Ποσοστό (%)</label>
        <input pInputText type="number" min="0" max="100" class="w-full" placeholder="0" [(ngModel)]="enrollDiscountPercent" />
      </div>
      <div class="col-6">
        <label class="block text-sm mb-1">Ποσό (€)</label>
        <input pInputText type="number" min="0" step="0.01" class="w-full" placeholder="0.00" [(ngModel)]="enrollDiscountAmount" />
      </div>
    </div>
    <div class="mt-2">
      <label class="block text-sm mb-1">Σημείωση έκπτωσης</label>
      <textarea
        class="p-inputtext p-component w-full border border-surface-300 rounded-md p-2"
        rows="2"
        [(ngModel)]="enrollDiscountNote"
        placeholder="Λόγος έκπτωσης..."
      ></textarea>
    </div>
  }

  <ng-template pTemplate="footer">
    <button
      pButton
      label="Ακύρωση"
      class="p-button-text"
      (click)="enrollDialogVisible.set(false)"
    ></button>
    <button
      pButton
      label="Εγγραφή"
      [disabled]="!selectedClassId || enrolling()"
      [loading]="enrolling()"
      (click)="confirmEnroll()"
    ></button>
  </ng-template>
</p-dialog>

<!-- Edit Enrollment Discount Dialog -->
<p-dialog
  [visible]="editDiscountDialogVisible()"
  (visibleChange)="editDiscountDialogVisible.set($event)"
  [modal]="true"
  [draggable]="false"
  [style]="{ width: '480px', maxWidth: '95vw' }"
  header="Επεξεργασία Έκπτωσης"
  [closable]="true"
  [dismissableMask]="true"
>
  @if (selectedEnrollmentForDiscount()) {
    <div class="mb-3">
      <div class="text-sm text-600 mb-1">Μάθημα</div>
      <div class="font-semibold">{{ selectedEnrollmentForDiscount()!.course_class?.title }}</div>
    </div>

    <p-divider></p-divider>

    <div class="mb-3">
      <label class="block font-semibold mb-2">Έκπτωση (%)</label>
      <input pInputText type="number" min="0" max="100" [(ngModel)]="discountPercent"
             placeholder="0" class="w-full" />
    </div>

    <div class="mb-3">
      <label class="block font-semibold mb-2">Έκπτωση (ποσό €)</label>
      <input pInputText type="number" min="0" step="0.01" [(ngModel)]="discountAmount"
             placeholder="0.00" class="w-full" />
    </div>

    <div class="mb-3">
      <label class="block font-semibold mb-2">Σημείωση έκπτωσης</label>
      <textarea class="p-inputtext p-component w-full border border-surface-300 rounded-md p-2"
                rows="3" [(ngModel)]="discountNote"
                placeholder="Λόγος έκπτωσης..."></textarea>
    </div>
  }

  <ng-template pTemplate="footer">
    <button
      pButton
      label="Ακύρωση"
      class="p-button-text"
      (click)="editDiscountDialogVisible.set(false)">
    </button>
    <button
      pButton
      label="Αποθήκευση"
      [loading]="savingDiscount()"
      [disabled]="savingDiscount()"
      (click)="saveEnrollmentDiscount()">
    </button>
  </ng-template>
</p-dialog>

<p-confirmDialog></p-confirmDialog>