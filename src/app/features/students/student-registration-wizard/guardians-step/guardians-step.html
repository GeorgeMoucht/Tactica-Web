<div class="flex justify-content-between align-items-center mb-3">
  <div class="text-md font-semibold">Κηδεμόνες</div>
  <div class="flex gap-2">
    <p-button
      label="Προσθήκη κηδεμόνα"
      icon="pi pi-plus"
      (onClick)="addNew.emit()">
    </p-button>
    
    <p-button
      label="Επιλογή από υπάρχοντες"
      icon="pi pi-users"
      [outlined]="true"
      (onClick)="openPicker()"
      [disabled]="loadingExisting()">
    </p-button>
  </div>
</div>

<!-- Guardians list -->
<div class="flex flex-column gap-3">
  <div
    class="surface-50 border-round p-3"
    *ngFor="let _ of guardians.controls; let i = index"
    [formGroup]="fg(i)">

    <div class="flex justify-content-between align-items-start mb-2">
      <div class="font-medium">{{ displayName(i) }}</div>
      <div class="flex gap-2">
        <p-tag *ngIf="fg(i).controls.id.value" value="Υπάρχων" severity="secondary"></p-tag>
        <p-button
          icon="pi pi-trash"
          severity="danger"
          [text]="true"
          (onClick)="removeAt(i)">
        </p-button>
      </div>
    </div>

    <div class="grid">
      <div class="col-12 md:col-6">
        <label>Όνομα</label>
        <input pInputText type="text" formControlName="first_name" class="w-full" />
      </div>

      <div class="col-12 md:col-6">
        <label>Επώνυμο</label>
        <input pInputText type="text" formControlName="last_name" class="w-full" />
      </div>

      <div class="col-12 md:col-6">
        <label>Σχέση</label>
        <p-select
          [options]="relations"
          optionLabel="label"
          optionValue="value"
          formControlName="relation"
          class="w-full">
        </p-select>
      </div>

      <div class="col-12 md:col-6">
        <label>Τηλέφωνο</label>
        <input pInputText type="text" formControlName="phone" class="w-full" />
      </div>

      <div class="col-12 md:col-6">
        <label>Email</label>
        <input pInputText type="email" formControlName="email" class="w-full" />
      </div>

      <!-- Address (nested) -->
      <div class="col-12"><p-divider align="left" type="solid"><b>Διεύθυνση</b></p-divider></div>

      <div class="col-12 md:col-4" [formGroup]="addr(i)">
        <label>Οδός</label>
        <input pInputText type="text" formControlName="street" class="w-full" />
      </div>
      <div class="col-12 md:col-4" [formGroup]="addr(i)">
        <label>Πόλη</label>
        <input pInputText type="text" formControlName="city" class="w-full" />
      </div>
      <div class="col-12 md:col-4" [formGroup]="addr(i)">
        <label>Τ.Κ.</label>
        <input pInputText type="text" formControlName="zip" class="w-full" />
      </div>
    </div>
  </div>

  <div *ngIf="guardians.length === 0" class="text-600 text-sm">
    Δεν έχουν προστεθεί κηδεμόνες ακόμα.
  </div>
</div>

<p-dialog
  header="Επιλογή υπάρχοντα κηδεμόνα"
  [(visible)]="pickerOpen"
  [modal]="true"
  [style]="{ width: '800px' }"
  [draggable]="false"
  appendTo="body">

  <!-- Seach bar -->
  <div class="flex gap-2 mb-3">
    <input
      pInputText
      class="w-full"
      type="text"
      placeholder="Αναζήτηση ονόματος/τηλ/email"
      [(ngModel)]="filter"/>
  </div>

  <!-- Table -->
  <app-guardian-table
    [rows]="optionsFiltered()"
    [loading]="loadingExisting()"
    mode="select"
    (select)="pickFromRow($event)">
  </app-guardian-table>

  <ng-template pTemplate="footer">
    <p-button
      label="Κλείσιμο"
      [text]="true"
      (onClick)="pickerOpen = false">
    </p-button>
  </ng-template>

</p-dialog>