<p-toast></p-toast>

<p-card>
  <div class="text-lg font-semibold mb-3">Νέα εγγραφή μαθητή</div>

  <p-stepper
    [(value)]="currentStep"
    [linear]="false"
    orientation="horizontal"
    class="w-full"
  >
    <p-step-list>
      <p-step [value]="1">Μαθητής</p-step>
      <p-step [value]="2" [disabled]="!isMinor()">Κηδεμόνες</p-step>
      <p-step [value]="3">Επιβεβαίωση</p-step>
    </p-step-list>

    <p-step-panels>
      <!-- STEP 1 -->
      <p-step-panel [value]="1">
        <ng-template #content let-activateCallback="activateCallback">
          <app-student-step [form]="form"></app-student-step>

          <div class="mt-3 flex justify-content-end gap-2">
            <p-button label="Άκυρο" [link]="true" routerLink="/students"></p-button>

            <p-button
              label="Επόμενο"
              icon="pi pi-arrow-right"
              [disabled]="form.get('name')?.invalid || form.get('birthdate')?.invalid"
              (onClick)="activateCallback(isMinor() ? 2 : 3)">
            </p-button>
          </div>
        </ng-template>
      </p-step-panel>

      <!-- STEP 2 (kept mounted; UI hidden if not minor) -->
      <p-step-panel [value]="2">
        <ng-template #content let-activateCallback="activateCallback">
          <ng-container *ngIf="isMinor(); else skipGuardian">
            <app-guardians-step
              [guardians]="guardiansFA"
              (addNew)="addGuardian()"
              (selectExisting)="addGuardian($event)"
              (remove)="removeGuardian($event)">
            </app-guardians-step>

            <div class="mt-3 flex justify-content-between gap-2">
              <p-button label="Πίσω" icon="pi pi-arrow-left" (onClick)="activateCallback(1)"></p-button>
              <p-button label="Επόμενο" icon="pi pi-arrow-right"
                        [disabled]="guardiansFA.length === 0"
                        (onClick)="activateCallback(3)"></p-button>
            </div>
          </ng-container>
          <ng-template #skipGuardian></ng-template>
        </ng-template>
      </p-step-panel>

      <!-- STEP 3 -->
      <p-step-panel [value]="3">
        <ng-template #content let-activateCallback="activateCallback">
          <app-review-step [form]="form" [isMinor]="isMinor()"></app-review-step>

          <div class="mt-3 flex justify-content-between gap-2">
            <p-button
              label="Πίσω"
              icon="pi pi-arrow-left"
              (onClick)="activateCallback(isMinor() ? 2 : 1)">
            </p-button>

            <p-button
              label="Αποθήκευση"
              icon="pi pi-check"
              severity="success"
              [loading]="saving()"
              [disabled]="saving()"
              (onClick)="save()">
            </p-button>
          </div>
        </ng-template>
      </p-step-panel>
    </p-step-panels>
  </p-stepper>
</p-card>
